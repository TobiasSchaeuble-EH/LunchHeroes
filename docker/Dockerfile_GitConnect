# --- Backend Build Stage ---
FROM python:3.9-slim as backend

WORKDIR /app

# Install git and Poetry
RUN apt-get update && apt-get install -y git \
    && pip install poetry

# Clone the repository from GitHub
RUN git clone https://github.com/TobiasSchaeuble-EH/LunchHeroes.git /app

# Install dependencies without creating a virtual environment
RUN poetry config virtualenvs.create false \
    && poetry install --no-dev --no-interaction --no-ansi

# --- Frontend Build Stage ---
FROM node:14 as frontend

WORKDIR /app

# Install git
RUN apt-get update && apt-get install -y git

# Clone the repository from GitHub
RUN git clone https://github.com/TobiasSchaeuble-EH/LunchHeroes.git /app

# Install dependencies
RUN npm install

# Build the frontend
RUN npm run build

# --- Nginx Stage ---
FROM nginx:alpine

# Copy the built frontend files to the Nginx server
COPY --from=frontend /app/frontend/build /usr/share/nginx/html

# Copy the backend app to a directory served by Gunicorn
COPY --from=backend /app/backend /app

# Set up Gunicorn to serve the backend app
COPY docker/gunicorn.conf /etc/gunicorn/gunicorn.conf

# Set up Nginx to proxy requests to Gunicorn
COPY docker/nginx.conf /etc/nginx/conf.d/default.conf

# Expose the necessary ports
EXPOSE 80

# Start Gunicorn and Nginx
CMD ["sh", "-c", "gunicorn -c /etc/gunicorn/gunicorn.conf app:app & nginx -g 'daemon off;'"]
